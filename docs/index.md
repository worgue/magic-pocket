---
title: Intro
---

# Magic Pocket - Django Serverless Deployment

magic-pocket の目標は、サーバレス Django です。Django を以下の環境にデプロイします。

- Container: AWS lambda
- Database: neon
- Storage: S3

!!! info "ライブラリ作るほどじゃない？英語が読めるならそうかもね。"
    このライブラリを作った理由として、英語ドキュメントへの苦労というのがあります。
    作者は日本人で英語が出来ません。
    日本語への機会翻訳は、ドキュメントを読む助けにはなりません。
    AWSインフラをコードに落とし込もうとすると、多くのドキュメントを読む必要がありました。
    もはや、プログラミングをしているのか、英語の勉強をしているのか分からない状況でした。

    「英語勉強すれば？」というのは、怠惰じゃないにも程がありますし、他の苦しむ人たちの助けにもならない。
    そもそもコマンド1つ叩いて環境が出来れば、日本語すら読めなくて良いし。


!!! success "リソースの理解について"
    AWS のリソースの多くはクラウドフォーメーションで作成されます。
    私は、そうでないリソースを作ってしまい、訳が分からなくなった事が何度もあり、作ってしまったリソースの把握も重要な要件だと思っています。

    例外として、データ保存を行う以下のリソースは API から直接作成されます。

    - S3 バケット
    - ECR レポジトリ
    - route53 レコード
    - secrets manager

## Motivation

小規模な個人プロジェクトを、1 人で複数同時に運用するため開発されたライブラリです。
気軽に作り、飽きたら放っておく、というスタイルで運用するため、以下の要件が最終目標になっています。

- サーバー保守をしなくて良い
- 使わない間のコストが不要
- 環境を作る前にやる気を出さなくても良い

## Background

小規模プロジェクトを運用する際、サーバーセキュリティをどうするかは、大きな課題でした。
サーバーがなければ悩みもない、という事でサーバーレスを検討していました。

それと並行して、小規模プロジェクトでは、複数環境を運用するコストが相対的に重く、開発用環境にコストをかけたくない、かといって本番環境と違う構成での開発も避けたい、という思いがありました。

この2つの悩みの解決策が同じ方向だったので、一度に問題が解決できるのでは？という疑問が湧き、以下の構成を試すことにしました。

- Container: lambda
- Database: neon
- Storage: s3
- Cache: EFS

??? question "なぜFargateを使わないのか？"
    最初は順当に Fargate を使いましたが、私が個人で保守するのは厳しいと感じました。

    `設定が分からない`
    :   特にヘルスチェック周りの設定が理解できませんでした。最初にDBに接続してmigrationを行いたいのに、ヘルスチェックが通らず詰みました。

    `インスタンスが立ち上がるのが遅い`
    :   今は知りませんが、当時、20分待ってやっと設定エラーで動かない事が分かる、という地獄に何度も会いました。
        また、せっかくサーバーレスなのに、アクセスにスパイクがあるとレスポンスが出来ない、というのは残念です。
        当然出来ると思い立ち上げたら、いきなり落ちて愕然としました。


!!! warning "固定費は必要"
    以下は、無視できない固定費として必要です。

    `NAT gateway`
    :   EFS の cache、neon の IP 制限、RDS（このライブラリでは未対応）などで必要。
        dev環境を大量に作るなら、共通化するか、そもそも作らないか検討が必須。

        magic-pocketでは、同プロジェクト内であれば、別環境でも共有する設定が可能。

    `secrets manager`
    :   個数に対する従量課金ではあるが、気軽に作りすぎると無視できないコストになる。
        可能な場合に保存場所を共通化すれば良い。

        magic-pocketでは、同プロジェクト内であれば、別環境でも共有する設定が可能。

    `neon`
    :   月額サブスク料金。1アカウントで複数プロジェクト使えるので、他の選択肢と比較すれば十分安いと思われる。

これらの環境構築にあたり、最初はクラウドフォーメーションのテンプレートを作ろうとしていたのですが、Django側に同じ設定を書く必要があったり、コピペを間違えたり、一部のリソースが削除できなかったり、という問題がありました。

そうしている中で、「そもそも、やりたいことってこんな複雑なんだっけ？」という疑問が湧き、設定したい内容を toml で書くことから始めました。

5 行ぐらいでした。

その toml を元に、インフラ構築を行うライブラリを作成した結果が、magic-pocket です。
途中、toml が複雑になりすぎて yaml に変更しようかとも思いましたが、それならクラウドフォーメーションでいいじゃん、ということで複雑な機能を開発するのは止めて、設定ファイルは toml になっています。


## Features

- neon への DB 作成と lambda への接続情報登録
- S3 のバケット作成と、django の STORAGES 設定
- API Gateway の作成と、django の ALLOWED_HOSTS 設定
- lambda経由で management command を実行
- SPA のフロントエンドアップロード先の作成
- デプロイ環境ごとのdjango settings登録
- EFS を利用したキャッシュの設定
