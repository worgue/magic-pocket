---
title: Intro
---

# Magic Pocket - Django Serverless Deployment

magic-pocket は Django を、AWS lambda 環境に Docker イメージを利用してデプロイするためのライブラリです。
サーバレス Django というのが目標で、基本的には、AWS lambda + neon postgres + s3 storage という環境をターゲットとします。
AWS のリソースの多くはクラウドフォーメーションで作成するため、作成された環境の理解も簡単です。
例外として、データ保存を行う以下のリソースは API 経由で作成されます。

- S3 バケット
- ECR レポジトリ
- route53 レコード
- secrets manager

## Motivation

小規模な個人プロジェクトを、1 人で複数同時に運用するためのインフラ構築のために開発されたライブラリです。
プロジェクトの目標は、使わない間のコストが不要な環境を、簡単にいくらでも構築できることです。

## Background

個人プロジェクトを運用する際、サーバーセキュリティに悩みたくない、というのがスタートで、Fargate か lambda と考えていました。
最初は順当に Fargate を使っていたのですが、複雑すぎて理解できなくなったことと、インスタンスが立ち上がるのを 20 分待った後に設定エラーで動かない、という地獄を何度か経て、lambda に切り替えました。

また、小規模な個人プロジェクトでは、複数環境を運用するコストが相対的に重く、dev と test 環境にはコストをかけたくない、かといって、本番環境と違う構成で開発を行うのも避けたい、という思いがありました。
そのため、完全にサーバレスで、使用しない間のコストがかからない環境を構築できるのか？という疑問からスタートして、以下の構成にたどり着きました。

- Container: lambda
- Database: neon
- Storage: s3
- Cache: EFS

結局、いくつかの固定費は必要だったので、悩ましいところです。

- NAT gateway: EFS の cache、neon の IP 制限、RDS（このライブラリでは未対応）などで必要
- secrets manager: 個数に対して課金される

secrets manager は、保存場所を共通化することでコスト削減は出来そうです。magic-pocket でも、secrets manager の保存先を調整してコスト削減が可能です。
NAT については、本番環境とテスト環境の差異をどこまで許容するかですが、少なくとも、たくさん適当な dev 環境がほしい時などは、NAT は不要かと思います。

これらの環境構築にあたり、最初はクラウドフォーメーションのテンプレートを使い回す形で対応していたのですが、同じ設定を何箇所にも書く必要があったり、コピペを間違えたり、一部のリソースが削除できなかったり、という問題がありました。

そうしている中で、「そもそも、やりたいことってこんな複雑なんだっけ？」という疑問が湧き、設定したい内容を toml で書くことから始めました。

5 行ぐらいでした。

その toml を元に、インフラ構築を行うライブラリを作成した結果が、magic-pocket です。
途中、toml が複雑になりすぎて yaml に変更しようかとも思いましたが、それならクラウドフォーメーションでいいじゃん、ということで複雑な機能を開発するのは止めて、設定ファイルは toml になっています。

## Features

以下の様な機能があります。

- neon API を利用した DB 環境の構築と AWS secretsmanager への接続情報登録
- lambda から上記 DB 情報を自動読み込み
- lambda から django management command を実行
- S3 バケットの作成と、django の STORAGES 設定
- API Gateway の作成と、django の ALLOWED_HOSTS 設定
- SPA のフロントエンドアップロード先の作成
- デプロイ時の環境変数の設定
- EFS を利用したキャッシュの設定
