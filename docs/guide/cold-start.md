# コールドスタート

サーバーレス構成では、一定時間リクエストがないとLambdaのインスタンスが破棄され、次のリクエスト時に再起動（コールドスタート）が発生します。
このページでは、magic-pocketでデプロイしたDjangoアプリケーションのコールドスタート時間を実測データとともに紹介します。

| コンポーネント | コールドスタート | 条件 |
|--------------|----------------|------|
| **Lambda** | **約 4.5 秒** | 512 MB / x86_64 / コンテナイメージ |
| **TiDB Serverless** | **約 1 秒** | ap-northeast-1 |
| **合計（初回リクエスト）** | **約 5.7 秒** | |

---

## 計測環境

| 項目 | 値 |
|------|-----|
| Lambda メモリ | 512 MB |
| Lambda アーキテクチャ | x86_64 |
| パッケージタイプ | コンテナイメージ |
| Python | 3.12 |
| Django | 5.x |
| データベース | TiDB Serverless |
| リージョン | ap-northeast-1 |

---

## 計測結果

Lambda が完全にコールドな状態から、ログアウト → ログイン → ログアウト → ログイン を連続実行し、CloudWatch Logs の REPORT 行から計測しました。

### リクエスト一覧

| # | Duration | Init Duration | 操作 |
|---|----------|---------------|------|
| 1 | 1,169 ms | **4,488 ms** | 1回目ログアウト (POST) |
| 2 | 370 ms | — | リダイレクト |
| 3 | 10 ms | — | favicon.ico (404) |
| 4 | 24 ms | — | ログインページ表示 |
| 5 | 2,413 ms | — | 1回目ログイン (POST) |
| 6 | 265 ms | — | リダイレクト |
| 7 | **130 ms** | — | 2回目ログアウト (POST) |
| 8 | 207 ms | — | リダイレクト |
| 9 | 4 ms | — | favicon.ico |
| 10 | 2,397 ms | — | 2回目ログイン (POST) |
| 11 | 262 ms | — | リダイレクト |

### Init Duration（Lambda コールドスタート）: 約 4.5 秒

Init Duration `4,488 ms` はLambda自体の初期化時間です。以下が含まれます:

- Pythonランタイムの起動
- モジュールの import（Django、magic-pocket 等）
- SSM Parameter Store からのシークレット取得
- Django アプリケーションの初期化

### TiDB Serverless コールドスタートの推定: 約 1 秒

同じ「ログアウト POST」操作の Duration を比較すると:

| | Duration | 状態 |
|---|---------|------|
| 1回目ログアウト | 1,169 ms | Lambda初回 + TiDB初回接続 |
| 2回目ログアウト | 130 ms | すべてウォーム |
| **差分** | **約 1,039 ms** | |

この約 1 秒の差が、TiDB Serverless のウェイクアップおよび初回の TCP コネクション確立・TLS ハンドシェイクのコストと推定されます。

裏付けとして、1回目ログイン POST (2,413 ms) と 2回目ログイン POST (2,397 ms) はほぼ同じ時間です。1回目ログアウトで TiDB への接続が確立済みのため、以降のリクエストではコールドスタートの影響が見られません。

---

## まとめ

| コンポーネント | コールドスタート時間 |
|--------------|-------------------|
| Lambda (Init Duration) | 約 4.5 秒 |
| TiDB Serverless 初回接続 | 約 1 秒 |
| **合計（初回リクエスト）** | **約 5.7 秒** |

ウォーム状態であれば、同じログアウト操作が 130 ms で完了しています。

!!! note "ログイン POST が常に約 2.4 秒かかる理由"
    これはコールドスタートとは無関係です。Django のパスワード認証で使用される PBKDF2 ハッシュ検証の計算コストによるものです。Lambda のメモリ（= CPU）を増やすことで短縮できます。

!!! tip "コールドスタートを軽減するには"
    - **Lambda メモリを増やす**: メモリに比例して CPU も割り当てられるため、Init Duration が短縮されます
    - **Provisioned Concurrency**: 常にウォームなインスタンスを維持できます（追加コストあり）
    - **定期的なウォームアップ**: EventBridge で定期的にリクエストを送ることで、インスタンスを維持できます
