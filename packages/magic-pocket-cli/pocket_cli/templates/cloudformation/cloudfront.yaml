AWSTemplateFormatVersion: "2010-09-09"
Description: spa configuration for webapp

Resources:
  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: "{{ resource_prefix }}oac"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # {% if domain %}
  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: "{{ domain }}"
      DomainValidationOptions:
        - DomainName: "{{ domain }}"
          HostedZoneId: "{{ hosted_zone_id }}"
      Tags:
        - Key: Name
          Value: "{{ resource_prefix }}cloudfront-cert"
      ValidationMethod: DNS
  # {% endif %}

  # {% if api_origins %}
  ApiOriginRequestPolicy:
    Type: AWS::CloudFront::OriginRequestPolicy
    Properties:
      OriginRequestPolicyConfig:
        Name: "{{ resource_prefix }}api-origin-request"
        CookiesConfig:
          CookieBehavior: all
        HeadersConfig:
          HeaderBehavior: allViewerExceptHostHeader
        QueryStringsConfig:
          QueryStringBehavior: all
  # {% endif %}

  # {% for route in routes %}
  # {% if route.is_spa %}
  UrlFallbackFunction{{ route.yaml_key }}:
    Type: AWS::CloudFront::Function
    Properties:
      Name: "{{ resource_prefix }}cloudfront-{{ route.name }}-fallback"
      AutoPublish: true
      FunctionCode: |
        {{ route.url_fallback_function_indent8 }}
      FunctionConfig:
        Comment: "Function to handle SPA url fallback"
        Runtime: cloudfront-js-2.0
  # {% endif %}
  # {% if route.is_versioned %}
  ResponseHeadersPolicy{{ route.yaml_key }}:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: "{{ resource_prefix }}{{ route.name }}"
        CustomHeadersConfig:
          Items:
            - Header: "cache-control"
              Value: "max-age={{ route.versioned_max_age }}"
              Override: true
  # {% endif %}
  # {% endfor %}

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - OriginAccessControl
      # {% if domain %}
      - Certificate
      # {% endif %}
      # {% if api_origins %}
      - ApiOriginRequestPolicy
      # {% endif %}
      # {% for route in routes %}
      # {% if route.is_spa %}
      - UrlFallbackFunction{{ route.yaml_key }}
      # {% endif %}
      # {% if route.is_versioned %}
      - ResponseHeadersPolicy{{ route.yaml_key }}
      # {% endif %}
      # {% endfor %}
    Properties:
      DistributionConfig:
        # {% if domain %}
        Aliases:
          - "{{ domain }}"
        # {% endif %}
        Enabled: true
        Origins:
          # {% for route in routes %}
          # {% if not route.is_api %}
          - Id: "{{ resource_prefix }}{{ route.name }}"
            DomainName: "{{ bucket_name }}.s3.{{ s3_region }}.amazonaws.com"
            OriginPath: "{{ route.origin_path }}"
            OriginAccessControlId:
              Fn::GetAtt: OriginAccessControl.Id
            S3OriginConfig:
              OriginAccessIdentity: "" # Leave this blank because we use OAC(Origin Access Control)
          # {% endif %}
          # {% endfor %}
          # {% for handler_key, import_name in api_origins.items() %}
          - Id: "{{ resource_prefix }}api-{{ handler_key }}"
            DomainName:
              Fn::ImportValue: "{{ import_name }}"
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              HTTPSPort: 443
          # {% endfor %}
        DefaultCacheBehavior:
          CachePolicyId: "658327ea-f89d-4fab-a63d-7e88639e58f6" # Managed-CachingOptimized
          TargetOriginId: "{{ resource_prefix }}{{ default_route.name }}"
          ViewerProtocolPolicy: "redirect-to-https"
          # {% if default_route.is_spa %}
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN:
                Fn::GetAtt: UrlFallbackFunction{{ default_route.yaml_key }}.FunctionMetadata.FunctionARN
          # {% endif %}
          # {% if default_route.is_versioned %}
          ResponseHeadersPolicyId:
            Ref: ResponseHeadersPolicy{{ default_route.yaml_key }}
          # {% endif %}
          # {% if default_route.signed and signing_key %}
          TrustedKeyGroups:
            - Fn::ImportValue: "{{ export.key_group_id }}"
          # {% endif %}
        # {% if extra_routes or api_routes %}
        CacheBehaviors:
          # {% for route in extra_routes %}
          - CachePolicyId: "658327ea-f89d-4fab-a63d-7e88639e58f6" # Managed-CachingOptimized
            TargetOriginId: "{{ resource_prefix }}{{ route.name }}"
            ViewerProtocolPolicy: "redirect-to-https"
            PathPattern: "{{ route.path_pattern }}"
            # {% if route.is_spa %}
            FunctionAssociations:
              - EventType: viewer-request
                FunctionARN:
                  Fn::GetAtt: UrlFallbackFunction{{ route.yaml_key }}.FunctionMetadata.FunctionARN
            # {% endif %}
            # {% if route.is_versioned %}
            ResponseHeadersPolicyId:
              Ref: ResponseHeadersPolicy{{ route.yaml_key }}
            # {% endif %}
            # {% if route.signed and signing_key %}
            TrustedKeyGroups:
              - Fn::ImportValue: "{{ export.key_group_id }}"
            # {% endif %}
          # {% endfor %}
          # {% for route in api_routes %}
          - CachePolicyId: "4135ea2d-6df8-44a3-9df3-4b5a84be39ad" # Managed-CachingDisabled
            OriginRequestPolicyId:
              Ref: ApiOriginRequestPolicy
            TargetOriginId: "{{ resource_prefix }}api-{{ route.handler }}"
            ViewerProtocolPolicy: "redirect-to-https"
            PathPattern: "{{ route.path_pattern }}"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - PATCH
              - POST
              - DELETE
          # {% endfor %}
        # {% endif %}
        ViewerCertificate:
          # {% if domain %}
          AcmCertificateArn:
            Ref: Certificate
          SslSupportMethod: sni-only
          # {% else %}
          CloudFrontDefaultCertificate: true
          # {% endif %}

  # {% if domain %}
  DNSRecord:
    Type: AWS::Route53::RecordSet
    DependsOn:
      - CloudFrontDistribution
    Properties:
      HostedZoneId: "{{ hosted_zone_id }}"
      Name: "{{ domain }}"
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2 # Z2FDTNDATAQYW2 is the fixed hosted zone id for cloudfront
        DNSName:
          Fn::GetAtt: CloudFrontDistribution.DomainName
  # {% endif %}

  # {% for rf in redirect_from %}
  "Certificate{{ rf.yaml_key }}":
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: "{{ rf.domain }}"
      DomainValidationOptions:
        - DomainName: "{{ rf.domain }}"
          HostedZoneId: "{{ hosted_zone_id }}"
      Tags:
        - Key: Name
          Value: "{{ resource_prefix }}spa-cert-{{ rf.yaml_key }}"
      ValidationMethod: DNS

  "CloudFrontDistribution{{ rf.yaml_key }}":
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - "{{ rf.domain }}"
        Enabled: true
        Origins:
          - Id: "redirect-from"
            DomainName:
              Fn::Sub: "{{ rf.bucket_website_domain }}"
            CustomOriginConfig:
              OriginProtocolPolicy: http-only
        DefaultCacheBehavior:
          CachePolicyId: "4135ea2d-6df8-44a3-9df3-4b5a84be39ad" # Managed-CachingDisabled
          TargetOriginId: "redirect-from"
          ViewerProtocolPolicy: "redirect-to-https"
        ViewerCertificate:
          AcmCertificateArn:
            Ref: "Certificate{{ rf.yaml_key }}"
          SslSupportMethod: sni-only

  "DNSRecord{{ rf.yaml_key }}":
    Type: AWS::Route53::RecordSet
    DependsOn:
      - "CloudFrontDistribution{{ rf.yaml_key }}"
    Properties:
      HostedZoneId: "{{ hosted_zone_id }}"
      Name: "{{ rf.domain }}"
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2 # Z2FDTNDATAQYW2 is the fixed hosted zone id for cloudfront
        DNSName:
          Fn::GetAtt: "CloudFrontDistribution{{ rf.yaml_key }}.DomainName"
  # {% endfor %}

Outputs:
  DistributionId:
    Value:
      Ref: CloudFrontDistribution
  DistributionDomainName:
    Value:
      Fn::GetAtt: CloudFrontDistribution.DomainName
